åç»­ä¼˜åŒ–é—®é¢˜è¯¦æƒ…
ä»¥ä¸‹æ˜¯å»ºè®®åœ¨æ–°çª—å£ä¸­å¤„ç†çš„é—®é¢˜ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼š

ğŸŸ  é—®é¢˜ 1ï¼šå±•å¼€çŠ¶æ€ä¸‰é‡å­˜å‚¨
ä¸¥é‡ç¨‹åº¦ï¼šä¸­ç­‰
å½±å“ï¼šå±•å¼€/æŠ˜å åŠŸèƒ½å¶å‘å¼‚å¸¸ï¼Œæ»šåŠ¨åçŠ¶æ€ä¸¢å¤±

é—®é¢˜æè¿°ï¼š
å±•å¼€çŠ¶æ€åŒæ—¶å­˜å‚¨åœ¨ä¸‰ä¸ªåœ°æ–¹ï¼Œè™šæ‹Ÿæ»šåŠ¨é‡æ¸²æŸ“æ—¶éœ€è¦æ‰‹åŠ¨åŒæ­¥ï¼Œå®¹æ˜“ä¸ä¸€è‡´ï¼š


// 1. state.js ä¸­çš„ Set
expandedEntries[lorebookName].has(uid)

// 2. DOM å±æ€§
$entry.attr('data-expanded')

// 3. CSS æ˜¾ç¤ºçŠ¶æ€
$entry.find('.entry-expand-area').is(':visible')
æ¶‰åŠæ–‡ä»¶ï¼š

state.js:104-127 - toggleEntryExpanded
list.js:316-360 - clusterChanged å›è°ƒä¸­çš„åŒæ­¥é€»è¾‘
events.js:896-940 - expand action å¤„ç†
å»ºè®®æ–¹æ¡ˆï¼š
åˆ›å»º modules/ui/expandManager.js ç»Ÿä¸€ç®¡ç†ï¼š


// expandManager.js
import { isEntryExpanded, toggleEntryExpanded } from '../state.js';

/**
 * åŒæ­¥å±•å¼€çŠ¶æ€åˆ° DOMï¼ˆå•ä¸€æ•°æ®æºï¼šstate.jsï¼‰
 */
export function syncExpandState($entry, lorebookName, uid, styleHeight) {
  const isExpanded = isEntryExpanded(lorebookName, uid);
  
  $entry.attr('data-expanded', isExpanded ? 'true' : 'false');
  $entry.css('height', isExpanded ? 'auto' : `${styleHeight}px`);
  $entry.find('.entry-expand-area').toggle(isExpanded);
  $entry.find('.small-expand-button i')
    .toggleClass('fa-chevron-up', isExpanded)
    .toggleClass('fa-chevron-down', !isExpanded);
  
  return isExpanded;
}

/**
 * è®¾ç½®å±•å¼€çŠ¶æ€å¹¶åŒæ­¥ DOM
 */
export function setExpanded($entry, lorebookName, uid, expanded, styleHeight) {
  toggleEntryExpanded(lorebookName, uid, expanded);
  return syncExpandState($entry, lorebookName, uid, styleHeight);
}
ç„¶ååœ¨ list.js å’Œ events.js ä¸­ç»Ÿä¸€è°ƒç”¨è¿™ä¸ªæ¨¡å—ã€‚

ğŸŸ  é—®é¢˜ 2ï¼ševents.js è¿‡äºåºå¤§
ä¸¥é‡ç¨‹åº¦ï¼šä¸­ç­‰

å½±å“ï¼šéš¾ä»¥ç»´æŠ¤ã€æ— æ³•å•å…ƒæµ‹è¯•ã€ä»»ä½•æ”¹åŠ¨éƒ½å¯èƒ½å¼•å…¥bug

é—®é¢˜æè¿°ï¼š
events.js æœ‰ 1671 è¡Œï¼Œå•ä¸ªäº‹ä»¶å¤„ç†å™¨è¶…è¿‡ 1000 è¡Œçš„switch-caseï¼š


// events.js:275-1234-å·¨å¤§çš„äº‹ä»¶å§”æ‰˜å¤„ç†å™¨
$panel.on('click.lorebookAction...', '[data-action]', async function(e) {
  switch (action) {
    case 'toggle-entry': ...
    case 'delete-entries': ...
    case 'expand': ...
    // 50+ ä¸ª caseï¼Œæ¯ä¸ªå‡ åè¡Œ
  }
});
å»ºè®®æ–¹æ¡ˆï¼š
ä½¿ç”¨å‘½ä»¤æ¨¡å¼æ‹†åˆ†ï¼š


modules/
â”œâ”€â”€ events.js              # ç®€åŒ–ä¸ºäº‹ä»¶åˆ†å‘å™¨ (~100è¡Œ)
â””â”€â”€ commands/
    â”œâ”€â”€ index.js           # å‘½ä»¤æ³¨å†Œä¸­å¿ƒ
    â”œâ”€â”€ entryCommands.js   # æ¡ç›®æ“ä½œå‘½ä»¤
    â”œâ”€â”€ batchCommands.js   # æ‰¹é‡æ“ä½œå‘½ä»¤
    â”œâ”€â”€ filterCommands.js  # ç­›é€‰å‘½ä»¤
    â””â”€â”€ globalCommands.js  # å…¨å±€ä¸–ç•Œä¹¦å‘½ä»¤

// commands/index.js
const commandHandlers = {};

export function registerCommand(action, handler) {
  commandHandlers[action] = handler;
}

export async function dispatchCommand(action, context) {
  const handler = commandHandlers[action];
  if (!handler) {
    console.warn(`æœªçŸ¥æ“ä½œ: ${action}`);
    return;
  }
  return handler(context);
}

// commands/entryCommands.js
import { registerCommand } from './index.js';

registerCommand('expand', async ({ $item, lorebookName, uid }) => {
  // å±•å¼€é€»è¾‘
});

registerCommand('toggle-entry', async ({ $item, lorebookName, uid, isGlobal }) => {
  // åˆ‡æ¢å¯ç”¨é€»è¾‘
});

// events.js ç®€åŒ–ä¸º
$panel.on('click.lorebookAction', '[data-action]', async function(e) {
  const action = $(this).data('action');
  await dispatchCommand(action, {
    event: e, 
    $el: $(this), 
    lorebookName, 
    isGlobal 
  });
});
ğŸŸ¡ é—®é¢˜ 3ï¼šAPI é”™è¯¯è¢«é™é»˜åæ²¡
ä¸¥é‡ç¨‹åº¦ï¼šä½

å½±å“ï¼šè°ƒç”¨è€…æ— æ³•åŒºåˆ†"ä¸–ç•Œä¹¦ä¸ºç©º"å’Œ"API è°ƒç”¨å¤±è´¥"

é—®é¢˜æè¿°ï¼š
api.js:100-117 ä¸­æ‰€æœ‰é”™è¯¯éƒ½è¿”å›ç©ºæ•°ç»„ï¼š


export const getWorldbookSafe = errorCatched(async worldbookName => {
  try {
    const entries = await getWorldbook(worldbookName);
    return entries || [];
  } catch (error) {
    console.error(`è·å–ä¸–ç•Œä¹¦å¤±è´¥`, error);
    return []; // è°ƒç”¨è€…æ— æ³•çŸ¥é“æ˜¯å¤±è´¥è¿˜æ˜¯çœŸçš„ä¸ºç©º
  }
}, 'getWorldbook');
å»ºè®®æ–¹æ¡ˆï¼š
ä½¿ç”¨ Result æ¨¡å¼ï¼š


/**
 * @typedef {Object} ApiResult
 * @property {boolean} success - æ˜¯å¦æˆåŠŸ
 * @property {any} data - è¿”å›æ•°æ®
 * @property {Error} [error] - é”™è¯¯å¯¹è±¡ï¼ˆå¤±è´¥æ—¶ï¼‰
 */

export const getWorldbookSafe = errorCatched(async worldbookName => {
  if (!worldbookName) {
    return { success: false, error: new Error('æœªæä¾›ä¸–ç•Œä¹¦å'), data: [] };
  }
  
  try {
    const entries = await getWorldbook(worldbookName);
    return { success: true, data: entries || [] };
  } catch (error) {
    console.error(`è·å–ä¸–ç•Œä¹¦å¤±è´¥: ${worldbookName}`, error);
    return { success: false, error, data: [] };
  }
}, 'getWorldbook');

// è°ƒç”¨æ–¹å¯ä»¥åŒºåˆ†
const result = await getWorldbookSafe('myBook');
if (!result.success) {
  toastr.error('åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥ï¼Œè¯·é‡è¯•');
  return;
}
const entries = result.data;
ğŸŸ¡ é—®é¢˜ 4ï¼šè™šæ‹Ÿæ»šåŠ¨é«˜åº¦è®¡ç®—è„†å¼±
ä¸¥é‡ç¨‹åº¦ï¼šä½

å½±å“ï¼šHTML ç»“æ„æ”¹å˜å¯èƒ½å¯¼è‡´é«˜åº¦è®¡ç®—é”™è¯¯

é—®é¢˜æè¿°ï¼š
list.js:244-298 ä¾èµ–æ­£åˆ™æ›¿æ¢å¼ºåˆ¶æŠ˜å çŠ¶æ€ï¼š


// éå¸¸è„†å¼±çš„å®ç°
sampleHtml = sampleHtml.replace(/data-expanded=\"true\"/g, 'data-expanded=\"false\"');
å»ºè®®æ–¹æ¡ˆï¼š
ä½¿ç”¨ DOM æ“ä½œæ›¿ä»£å­—ç¬¦ä¸²æ›¿æ¢ï¼š


function measureCollapsedHeight(entry, lorebookName) {
  // åˆ›å»ºä¸´æ—¶å®¹å™¨
  const $temp = $('<div>')
    .css({ position: 'absolute', visibility: 'hidden', left: '-9999px' })
    .appendTo('body');
  
  // æ’å…¥ HTML
  $temp.html(createEntryHtml(entry, lorebookName));
  
  // ä½¿ç”¨ DOM API ç¡®ä¿æŠ˜å çŠ¶æ€
  const $entry = $temp.find('.lorebook-entry-item');
  $entry.attr('data-expanded', 'false');
  $entry.find('.entry-expand-area').hide();
  
  // æµ‹é‡é«˜åº¦
  const height = $entry.outerHeight();
  // æ¸…ç†
  $temp.remove();
  
  return height;
}