# 墨剑录 - 修为/境界/功法/属性/战斗体系架构

## 设计背景
这是一个基于酒馆LLM对话的综武RPG角色卡前端。为减少LLM不确定性，事件系统交给其他脚本处理，前端负责：
- 显示内容
- 读取/修改变量
- 消耗修为进行升级/修行功法/提升熟练度
- 动态提示词生成（如战斗系数计算）

---

## 一、境界体系 ✓ 已确认

### 1.1 境界划分
**大境界（7级）**：不入流 → 三流 → 二流 → 一流 → 宗师 → 绝顶 → 陆地神仙
**小境界（4级）**：初期 → 中期 → 后期 → 圆满

### 1.2 境界系数
用于属性计算的乘数：

| 大境界     | 系数       |
| ---------- | ---------- |
| 不入流     | 1          |
| 三流       | 10         |
| 二流       | 100        |
| 一流       | 1000       |
| 宗师       | 10000      |
| 绝顶       | **50000**  |
| 陆地神仙   | **100000** |

**小境界系数**：初期 1.0 / 中期 1.2 / 后期 1.4 / 圆满 1.6

### 1.3 境界升级消耗表 ✓ 已确认

**说明**：
- 不入流没有小境界划分，消耗500修为直接突破到三流初期
- 消耗值为升级到该境界所需的修为

| 境界       | 初期   | 中期   | 后期   | 圆满    |
| ---------- | ------ | ------ | ------ | ------- |
| 不入流     | -      | -      | -      | 500     |
| 三流       | 500    | 700    | 900    | 1200    |
| 二流       | 1500   | 2000   | 2800   | 4000    |
| 一流       | 6000   | 10000  | 15000  | 25000   |
| 宗师       | 40000  | 60000  | 90000  | 140000  |
| 绝顶       | 200000 | 300000 | 450000 | 650000  |
| 陆地神仙   | 800000 | 900000 | 950000 | 1000000 |

**节奏参考**：三流初期 + 上乘内功(融会贯通)，每日修行获得14修为
- 三流初期→中期：700消耗 ≈ **50天**

---

## 二、功法体系 ✓ 已确认

### 2.1 功法品阶（6级）
粗浅 → 传家 → 上乘 → 镇派 → 绝世 → 传说

**品阶影响**：功法特性数量
- 粗浅：无特性
- 传家：1个特性（出神入化解锁）
- 上乘：2个特性
- 镇派：3个特性
- 绝世：4个特性
- 传说：5个特性（每个掌握程度都有一个特性）

### 2.2 掌握程度（5级）
初窥门径 → 略有小成 → 融会贯通 → 炉火纯青 → 出神入化

**提升方式**：消耗修为（修行、练武、战斗都会产生修为）

### 2.3 功法种类与定位

| 类型 | 定位 | 影响 |
| ---- | ---- | ---- |
| 内功 | 修行核心 | 影响属性值、修行速度 |
| 外功 | 护体硬功 | 影响属性值（铁布衫、龙象般若功等） |
| 轻功 | 身法闪避 | 影响机敏相关属性 |
| 武技 | 战斗招式 | 影响战斗系数 |

**武技细分**：剑法 / 刀法 / 拳掌 / 指法 / 暗器 / 枪戟 / 棍锤
（细分是为了动态提示词计算战斗系数）

### 2.4 特殊功法处理
如凌波微步（轻功但有修行效果）：
- 通过**功法特性**实现特殊效果
- 特性内容由LLM根据功法描述处理
- 前端只负责显示和基础计算

---

## 三、功法数据库与前端职责 ✓ 已确认

### 3.1 设计理念
**核心目标**：减少LLM聊天过程的不确定性，把功法相关内容全部存储在前端。

**数据流**：
1. **新角色生成**：LLM只需写入`功法名`和`掌握程度`到变量
2. **前端补全**：根据功法名从数据库读取完整信息（类型、品阶、特性、战斗系数等）
3. **行囊功法**：前端检查修炼限制（属性要求），计算学习消耗
4. **学习功法**：前端更新武功变量，显示在功法面板
5. **动态计算**：前端根据角色属性+功法配置，实时计算战斗数值

### 3.2 功法数据库结构
前端内置功法数据库（JSON格式），由LLM预处理武侠小说提取：

```json
{
  "独孤九剑": {
    "类型": "剑法",
    "功法品阶": "传说",
    "功法描述": "令狐冲所学，以无招胜有招，料敌先机",
    "修炼限制": {
      "洞察": 14,
      "机敏": 10
    },
    "战斗系数": {
      "属性列表": [
        { "属性": "洞察", "系数": 1.0, "乘境界": false },
        { "属性": "机敏", "系数": 0.6, "乘境界": false },
        { "属性": "悟性", "系数": 0.4, "乘境界": true }
      ]
    },
    "特性": {
      "初窥门径": "破剑式：对剑法类攻击+10%克制",
      "略有小成": "破刀式：对刀法类攻击+10%克制",
      "融会贯通": "破掌式：对拳掌类攻击+10%克制",
      "炉火纯青": "破气式：无视对手30%内力防御",
      "出神入化": "无招胜有招：战斗时洞察额外×1.5"
    }
  }
}
```

**注意**：战斗系数总和由品阶决定（粗浅0.6 → 传说2.0），详见第四章。

### 3.3 变量中的功法结构
LLM只需写入简化版本，前端负责读取和计算：

```json
"武功": {
  "独孤九剑": {
    "掌握程度": "融会贯通"
  },
  "九阳神功": {
    "掌握程度": "初窥门径"
  }
}
```

### 3.4 前端计算职责

| 功能 | 计算内容 | 数据来源 |
| ---- | -------- | -------- |
| 显示功法详情 | 类型、描述、特性 | 功法数据库 |
| 检查学习资格 | 属性是否满足修炼限制 | 数据库限制 + 角色属性 |
| 计算学习消耗 | 基础消耗 × 悟性折扣 | 品阶 + 悟性公式 |
| 计算升级消耗 | 提升掌握程度的修为 | 品阶 + 掌握程度 + 悟性 |
| 计算战斗数值 | 主属性×主系数 + 副属性×副系数 | 数据库 + 角色战斗属性 |
| 动态提示词 | 生成在场人物战斗系数表 | 所有计算结果汇总 |

---

## 四、战斗系数系统 ✓ 已确认（调整后）

### 4.1 战斗系数公式
```
战斗系数 = Σ(属性值 × 对应系数)
```

**核心改动**：
- 属性数量不限制：可以是1个、2个、3个甚至更多
- 系数总和随品阶提升：品阶越高，战斗力越强

### 4.2 品阶系数总和

| 品阶 | 系数总和 |
| ---- | -------- |
| 粗浅 | 0.6      |
| 传家 | 0.8      |
| 上乘 | 1.0      |
| 镇派 | 1.2      |
| 绝世 | 1.5      |
| 传说 | 2.0      |

**设计意图**：传说功法战斗力约为粗浅的3.3倍（2.0/0.6）

### 4.3 功法数据库结构（战斗系数部分）



### 4.4 武技类型默认配比参考
用于LLM提取功法时的参考（上乘品阶，系数和1.0）：


### 4.5 战斗系数示例





### 4.6 动态提示词生成示例
前端生成的战斗信息供LLM参考：

```
【在场人物战斗能力】
玩家（墨逸）：
- 独孤九剑（剑法/传说/融会贯通）：战斗系数 85000
- 九阳神功（内功/传说/初窥门径）：气血+50000，内力+80000

NPC（东方不败）：
- 葵花宝典（内功/传说/出神入化）：战斗系数 120000
```

---

## 四、属性体系 ✓ 已确认

### 4.1 初始属性（7维）
角色创建时分配，范围0-20，基本不变动：

| 属性 | 说明 |
| ---- | ---- |
| 臂力 | 力量相关 |
| 根骨 | 体质相关 |
| 机敏 | 敏捷相关 |
| 洞察 | 感知相关 |
| 悟性 | 学习相关（特殊：影响修为消耗折扣） |
| 风姿 | 魅力相关 |
| 福缘 | 运气相关 |

**属性分档与提示词**：

| 数值范围 | 等级 | 提示词 |
| -------- | ---- | ------ |
| 1-4      | 愚钝 | 负面提示词 |
| 5-8      | 普通 | 无特殊提示 |
| 9-12     | 人才 | 无特殊提示 |
| 12-16    | 天才 | 正面提示词A |
| 17-20    | 妖孽 | 正面提示词B |

### 4.2 战斗属性（可乘算）
受境界系数影响，用于战斗计算：

| 属性 | 来源 | 说明 |
| ---- | ---- | ---- |
| 臂力 | 初始臂力 × 境界系数 + 功法加成 | 力量型功法使用 |
| 根骨 | 初始根骨 × 境界系数 + 功法加成 | 防御/气血相关 |
| 机敏 | 初始机敏 × 境界系数 + 功法加成 | 速度/闪避相关 |
| 洞察 | 初始洞察 × 境界系数 + 功法加成 | 临敌感知，弱点识破 |

### 4.3 资源属性 ✓ 已确认
```
气血 = 根骨 × 外功加成
内力 = 根骨 × 内功加成
```

**功法加成公式**：
```
功法加成 = 品阶基础值 × (1 + 掌握程度系数)
```

**品阶基础值** ✓ 已确认（调整后）：

| 品阶 | 基础值 |
| ---- | ------ |
| 粗浅 | 1      |
| 传家 | 2      |
| 上乘 | 4      |
| 镇派 | 8      |
| 绝世 | 15     |
| 传说 | 25     |

**掌握程度系数** ✓ 已确认（调整后，直接作为乘数）：

| 掌握程度 | 系数 |
| -------- | ---- |
| 初窥门径 | 0.6  |
| 略有小成 | 0.8  |
| 融会贯通 | 1.0  |
| 炉火纯青 | 1.2  |
| 出神入化 | 1.5  |

**功法加成公式**（调整后）：
```
功法加成 = 品阶基础值 × 掌握程度系数
```

**示例计算**：
- 镇派外功·炉火纯青：8 × 1.2 = 9.6
- 传说内功·出神入化：25 × 1.5 = 37.5
- 根骨100，传说内功出神入化：内力 = 100 × 37.5 = 3750

### 4.4 固定属性（不乘算）
- 悟性：减少学习功法的修为消耗，减少提升熟练度的修为消耗（详见4.6）
- 风姿：影响社交、NPC好感
- 福缘：影响随机事件、掉落

### 4.5 战斗属性公式
```
臂力/根骨/机敏/洞察 = 初始属性 × 大境界系数 × 小境界系数 + 功法加成
```

### 4.6 悟性折扣公式 ✓ 已确认

悟性影响学习功法和提升熟练度的修为消耗，与功法品阶挂钩。

**功法品阶对应的悟性基准点**：

| 品阶 | 基准悟性 |
| ---- | -------- |
| 粗浅 | 0        |
| 传家 | 4        |
| 上乘 | 8        |
| 镇派 | 12       |
| 绝世 | 16       |
| 传说 | 20       |

**折扣公式**：
```
偏离值 = 悟性 - 基准悟性
折扣率 = clamp(偏离值 × 5%, -60%, +60%)
实际消耗 = 基础消耗 × (1 - 折扣率)
```

**示例计算**（上乘功法，基准悟性8，基础消耗100）：

| 悟性 | 偏离值 | 折扣率 | 实际消耗 |
| ---- | ------ | ------ | -------- |
| 2    | -6     | -30%   | 130      |
| 8    | 0      | 0%     | 100      |
| 14   | +6     | +30%   | 70       |
| 20   | +12    | +60%   | 40       |

**设计意图**：
- 悟性低于基准：学习更费修为（笨蛋学高级功法吃力）
- 悟性等于基准：正常消耗
- 悟性高于基准：学习省修为（天才学习快）
- 上下限±60%防止极端情况

---

## 六、功法学习与升级消耗 ✓ 已确认（调整后）

### 6.1 首次学习
**免费**：获得秘籍即可学习，不消耗修为。

### 6.2 品阶基础消耗（用于升级熟练度）

| 品阶 | 基础消耗 |
| ---- | -------- |
| 粗浅 | 100      |
| 传家 | 300      |
| 上乘 | 800      |
| 镇派 | 1500     |
| 绝世 | 4000     |
| 传说 | 10000    |

### 6.3 提升掌握程度消耗

**消耗系数**（调整为2的幂次）：

| 升级路径 | 系数 |
| -------- | ---- |
| 初窥门径 → 略有小成 | ×1 |
| 略有小成 → 融会贯通 | ×2 |
| 融会贯通 → 炉火纯青 | ×4 |
| 炉火纯青 → 出神入化 | ×8 |

**公式**：
```
升级消耗 = 品阶基础消耗 × 消耗系数 × 悟性折扣
```

### 6.4 示例计算

**上乘功法（基础800），三流角色每日14修为**：
- 初窥→略有：800 × 1 = 800 → **57天**
- 略有→融会：800 × 2 = 1600 → **114天**
- 融会→炉火：800 × 4 = 3200 → **229天**
- 炉火→出神：800 × 8 = 6400 → **457天**
- **总计**：12000修为 → **857天（约2.3年）**

**传说功法（基础10000），一流角色每日375修为**：
- 初窥→略有：10000 × 1 = 10000 → **27天**
- 略有→融会：10000 × 2 = 20000 → **53天**
- 融会→炉火：10000 × 4 = 40000 → **107天**
- 炉火→出神：10000 × 8 = 80000 → **213天**
- **总计**：150000修为 → **400天（约1.1年）**

---

## 七、修为获取系统 ✓ 已确认（调整后）

### 7.1 设计理念
前端计算"修为变化参考值"，代表**每日修行**可获得的修为量。LLM基于此值决定实际获取量。

### 7.2 修为变化参考公式（使用log2压缩境界系数）
```
修为变化参考 = log2(境界系数 + 1) × 品阶基础值 × 掌握程度系数
```

**log2压缩表**：

| 境界       | 境界系数 | log2(系数+1) |
| ---------- | -------- | ------------ |
| 不入流     | 1        | 1.0          |
| 三流       | 10       | 3.5          |
| 二流       | 100      | 6.7          |
| 一流       | 1000     | 10.0         |
| 宗师       | 10000    | 13.3         |
| 绝顶       | 50000    | 15.6         |
| 陆地神仙   | 100000   | 16.6         |

### 7.3 修为获取示例

| 角色境界 | 内功 | 掌握程度 | 计算 | 每日获取 |
| -------- | ---- | -------- | ---- | -------- |
| 三流初期 | 粗浅 | 初窥门径 | 3.5 × 1 × 0.6 | **2** |
| 三流初期 | 上乘 | 融会贯通 | 3.5 × 4 × 1.0 | **14** |
| 一流初期 | 传说 | 出神入化 | 10 × 25 × 1.5 | **375** |
| 陆地神仙 | 传说 | 出神入化 | 16.6 × 25 × 1.5 | **622** |

### 7.4 使用方式
- 前端计算并写入变量 `修为变化参考`
- 提示词告知LLM：**每日修行**获取修为约等于"修为变化参考"值
- LLM根据实际情况（修行时长、环境、机缘、奇遇等）微调数值

---

## 八、气血/内力计算 ✓ 已确认（调整后）

### 8.1 资源属性公式
```
气血上限 = 根骨(已乘境界) × 外功加成
内力上限 = 根骨(已乘境界) × 内功加成
功法加成 = 品阶基础值 × 掌握程度系数
```

### 8.2 变量存储格式
使用字符串格式 `当前值/上限值`：
```json
"属性": {
  "气血": "800/1000",
  "内力": "500/800",
  "额外内力上限": 100  // 北冥神功等特殊功法增加
}
```

### 8.3 前端处理逻辑
- 读取字符串，解析 `/` 前后的数值
- 更新上限时：只修改 `/` 后面的值
- 实际上限 = 基础上限 + 额外上限

### 8.4 特殊功法处理（北冥神功等）

**问题**：北冥神功等可以吸取内力增加上限的功法，如何处理？

**解决方案**：通过功法特性实现
```json
"北冥神功": {
  "类型": "内功",
  "功法品阶": "传说",
  "特性": {
    "初窥门径": "吸星摄魂：战胜敌人后可吸取其内力，增加额外内力上限（LLM修改'额外内力上限'变量）",
    "略有小成": "...",
    ...
  }
}
```

**工作流**：
1. 前端计算并更新 `基础上限`（根骨×功法加成）
2. LLM在吸取内力后更新 `额外内力上限`
3. 显示时：实际上限 = 基础上限 + 额外内力上限
4. 升级功法时基础上限增加，不影响额外上限，总上限只增不减

---

## 九、固定属性的战斗使用 ✓ 已确认

### 9.1 问题描述
悟性、风姿、福缘等固定属性不随境界乘算，但某些特殊功法需要使用它们。

### 9.2 解决方案
在战斗系数计算时，对固定属性单独乘以境界系数。

**示例**：独孤九剑使用悟性作为战斗属性
```
战斗系数 = (悟性 × 境界系数) × 0.7 + 机敏 × 0.3
```

### 9.3 功法数据库配置
```json
"独孤九剑": {
  "战斗系数": {
    "主属性": "悟性",
    "主系数": 0.7,
    "主属性乘境界": true,  // 新增：表示需要乘境界系数
    "副属性": "机敏",
    "副系数": 0.3,
    "副属性乘境界": false  // 机敏本身已经乘过境界
  }
}
```

**前端计算逻辑**：
```typescript
if (主属性乘境界) {
  主属性值 = 初始属性 × 境界系数
} else {
  主属性值 = 战斗属性值  // 已经乘过境界
}
```

---

## 体系总结

本文档已完成以下核心体系的设计：

1. ✓ **境界体系**：7大境界 × 4小境界，境界系数1~1000000
2. ✓ **功法体系**：6品阶 × 5掌握程度，品阶决定特性数量
3. ✓ **功法数据库**：前端内置，LLM只写功法名和掌握程度
4. ✓ **战斗系数**：主副属性配比，固定属性可单独乘境界
5. ✓ **属性体系**：7初始属性，4战斗属性，3固定属性
6. ✓ **悟性折扣**：与品阶基准点挂钩，±60%范围
7. ✓ **功法消耗**：学习100~10000，升级×1.0~×4.0
8. ✓ **修为获取**：前端计算参考值，LLM决定实际值
9. ✓ **气血/内力**：字符串格式，额外上限处理特殊功法

---


## 十、境界隐含功法保底机制 ✓ 新增

### 10.1 问题描述
小说中很多高手只描写招式（如蛤蟆功、降龙十八掌），不详细描写内功体系。
这导致提取出的角色"缺少内功"，在数值计算时反而比低境界角色更弱。

### 10.2 解决方案
**核心思想**：境界本身代表综合修为，高境界必然有相应的内功/外功底蕴。

### 10.3 境界隐含保底表

| 大境界   | 隐含等效  | 内功保底 | 外功保底 | 计算依据     |
| -------- | --------- | -------- | -------- | ------------ |
| 不入流   | 无        | 0        | 0        | 普通人无修为 |
| 三流     | 粗浅·初窥 | 0.6      | 0.6      | 1 × 0.6      |
| 二流     | 传家·融会 | 2.0      | 2.0      | 2 × 1.0      |
| 一流     | 上乘·融会 | 4.0      | 4.0      | 4 × 1.0      |
| 宗师     | 镇派·融会 | 8.0      | 8.0      | 8 × 1.0      |
| 绝顶     | 绝世·融会 | 15.0     | 15.0     | 15 × 1.0     |
| 陆地神仙 | 传说·融会 | 25.0     | 25.0     | 25 × 1.0     |

### 10.4 计算规则
```
实际内功加成 = max(显性内功加成, 境界保底)
实际外功加成 = max(显性外功加成, 境界保底)
```

### 10.5 示例对比

| 角色     | 境界 | 显性内功   | 保底 | 实际加成 |
| -------- | ---- | ---------- | ---- | -------- |
| 欧阳锋   | 绝顶 | 无(0)      | 15.0 | **15.0** |
| 郭靖     | 绝顶 | 九阴(37.5) | 15.0 | **37.5** |
| 普通弟子 | 三流 | 无(0)      | 0.6  | **0.6**  |

---

## 后续工作

- [x] ~~设计功法提取模板供LLM预处理小说使用~~ ✓ 已完成
- [x] ~~确定境界升级消耗表的具体数值~~ ✓ 已完成
- [x] ~~更新功法学习消耗（第六章）~~ ✓ 已完成
- [x] ~~新增境界隐含功法保底机制~~ ✓ 已完成
- [ ] 实现前端功法数据库和计算逻辑
- [ ] 设计动态提示词生成格式

