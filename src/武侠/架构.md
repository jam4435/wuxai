# å¢¨å‰‘å½• (Ink & Blade) é¡¹ç›®æ¶æ„æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

**å¢¨å‰‘å½•** æ˜¯ä¸€ä¸ªåŸºäºé…’é¦†åŠ©æ‰‹çš„æ²‰æµ¸å¼æ­¦ä¾ RPGå‰ç«¯ç•Œé¢ï¼Œé€šè¿‡è¯»å–å’Œç”ŸæˆèŠå¤©æ¶ˆæ¯ä¸­çš„å˜é‡æ¥é©±åŠ¨æ¸¸æˆçŠ¶æ€ã€‚æœ¬é¡¹ç›®åˆ©ç”¨ React æ„å»ºï¼Œä¸é…’é¦†åŠ©æ‰‹çš„åŸç”ŸåŠŸèƒ½æ·±åº¦é›†æˆã€‚

---

## 2. æ–‡ä»¶ç»“æ„

```
src/æ­¦ä¾ /
â”œâ”€â”€ App.tsx              # æ ¸å¿ƒåº”ç”¨ç»„ä»¶ï¼Œç®¡ç†é¡µé¢æµç¨‹å’Œä¸»å¸ƒå±€
â”œâ”€â”€ index.html           # å‰ç«¯ç•Œé¢HTMLå…¥å£
â”œâ”€â”€ index.tsx            # Reactåº”ç”¨æŒ‚è½½ç‚¹
â”œâ”€â”€ types.ts             # TypeScriptç±»å‹å®šä¹‰
â”œâ”€â”€ components/          # UIç»„ä»¶ç›®å½•
â”‚   â”œâ”€â”€ ChatInput.tsx      # èŠå¤©è¾“å…¥ç»„ä»¶
â”‚   â”œâ”€â”€ FullscreenButton.tsx # å…¨å±åˆ‡æ¢æŒ‰é’®
â”‚   â”œâ”€â”€ GameContent.tsx    # æ¸¸æˆå†…å®¹æ˜¾ç¤ºï¼ˆæ­£æ–‡+é€‰é¡¹ï¼‰
â”‚   â”œâ”€â”€ Icons.tsx          # å›¾æ ‡ç»„ä»¶
â”‚   â”œâ”€â”€ Modal.tsx          # é€šç”¨æ¨¡æ€æ¡†
â”‚   â”œâ”€â”€ NewGameSetup.tsx   # å¼€å±€è®¾ç½®ç•Œé¢ï¼ˆ7æ­¥æµç¨‹ï¼‰
â”‚   â”œâ”€â”€ SettingsPanel.tsx  # è®¾ç½®é¢æ¿
â”‚   â”œâ”€â”€ SplashScreen.tsx   # æ ‡é¢˜/é€‰æ‹©ç•Œé¢
â”‚   â”œâ”€â”€ StartScreen.tsx    # å¯åŠ¨ç•Œé¢
â”‚   â”œâ”€â”€ StatusToast.tsx    # çŠ¶æ€æç¤ºç»„ä»¶
â”‚   â””â”€â”€ panels/            # æ¸¸æˆé¢æ¿ç»„ä»¶ï¼ˆä» GamePanels.tsx æ‹†åˆ†ï¼‰
â”‚       â”œâ”€â”€ index.ts           # ç»Ÿä¸€å¯¼å‡º
â”‚       â”œâ”€â”€ EmptyState.tsx     # å…±ç”¨ç©ºçŠ¶æ€ç»„ä»¶
â”‚       â”œâ”€â”€ CharacterPanel.tsx # è§’è‰²é¢æ¿ï¼ˆå« StatBarã€Attributeï¼‰
â”‚       â”œâ”€â”€ MartialArtsPanel.tsx # åŠŸæ³•é¢æ¿
â”‚       â”œâ”€â”€ InventoryPanel.tsx # èƒŒåŒ…é¢æ¿
â”‚       â”œâ”€â”€ EventsPanel.tsx    # äº‹ä»¶é¢æ¿
â”‚       â”œâ”€â”€ SocialPanel.tsx    # ç¤¾äº¤é¢æ¿
â”‚       â””â”€â”€ MapPanel.tsx       # åœ°å›¾é¢æ¿
â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰ Hooksï¼ˆä» App.tsx æå–ï¼‰
â”‚   â”œâ”€â”€ index.ts             # ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ useDebugLogs.ts      # è°ƒè¯•æ—¥å¿—ç®¡ç†
â”‚   â”œâ”€â”€ useToast.ts          # Toast æç¤ºç®¡ç†
â”‚   â”œâ”€â”€ usePageFlow.ts       # é¡µé¢æµç¨‹çŠ¶æ€
â”‚   â”œâ”€â”€ useGameState.ts      # æ¸¸æˆçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ useEventListeners.ts # äº‹ä»¶ç›‘å¬é€»è¾‘
â”‚   â””â”€â”€ useMessageHandler.ts # æ¶ˆæ¯å‘é€å¤„ç†
â”œâ”€â”€ data/                # é™æ€æ•°æ®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ _åˆå¹¶ååŠŸæ³•.json    # åŠŸæ³•æ•°æ®åº“
â”‚   â”œâ”€â”€ äº‹ä»¶ä¿¡æ¯æ±‡æ€».json   # é¢„è®¾äº‹ä»¶æ•°æ®ï¼ˆäº‹ä»¶å+è§¦å‘æ—¶é—´ï¼‰
â”‚   â”œâ”€â”€ å¤©èµ„ç­‰çº§.json       # å¤©èµ„ç­‰çº§é…ç½®ï¼ˆå‡¡äºº/è‰¯æ‰/å¤©æ‰/ç»ä¸–ï¼‰
â”‚   â”œâ”€â”€ å±æ€§ç‚¹æ•°æ¶ˆè€—è¡¨.json # å±æ€§ç‚¹å’Œç¦ç¼˜ç‚¹æ•°æ¶ˆè€—è§„åˆ™
â”‚   â”œâ”€â”€ å¤–è²Œæè¿°æ¨¡æ¿.json   # æŒ‰æ€§åˆ«å’Œé£å§¿å€¼åˆ†ç±»çš„å¤–è²Œæè¿°æ¨¡æ¿
â”‚   â”œâ”€â”€ å¢ƒç•Œç³»ç»Ÿ.json       # å¢ƒç•Œç­‰çº§åˆ—è¡¨å’Œå¢ƒç•Œ-ä¿®ä¸ºæ˜ å°„
â”‚   â”œâ”€â”€ æ­¦åŠŸé€‰é¡¹.json       # åˆå§‹æ­¦åŠŸé€‰é¡¹ï¼ˆå¤ªç¥–é•¿æ‹³ã€ç½—æ±‰æ‹³ç­‰ï¼‰
â”‚   â”œâ”€â”€ å‡ºèº«é€‰é¡¹.json       # æ‰€æœ‰å‡ºèº«é€‰é¡¹ï¼ˆæ±Ÿæ¹–é—¨æ´¾/ä¸–å®¶è±ªé—¨/å¹³æ°‘ç™¾å§“/ç‰¹æ®Šèº«ä»½ï¼‰
â”‚   â””â”€â”€ å¼€åœºç™½.json         # å¼€åœºç™½å­—ç¬¦ä¸²æ•°ç»„
â”œâ”€â”€ styles/              # æ ·å¼ç›®å½• (æ¨¡å—åŒ– SCSS)
â”‚   â”œâ”€â”€ main.scss          # ä¸»å…¥å£
â”‚   â”œâ”€â”€ variables.scss     # SCSS å˜é‡
â”‚   â”œâ”€â”€ _reset.scss        # æ ·å¼é‡ç½®
â”‚   â”œâ”€â”€ _layout.scss       # å¸ƒå±€æ ·å¼
â”‚   â”œâ”€â”€ _header.scss       # å¤´éƒ¨æ ·å¼
â”‚   â”œâ”€â”€ _navigation.scss   # å¯¼èˆªæ ·å¼
â”‚   â”œâ”€â”€ _panels.scss       # é¢æ¿æ ·å¼
â”‚   â”œâ”€â”€ _chat.scss         # èŠå¤©æ ·å¼
â”‚   â”œâ”€â”€ _modal.scss        # æ¨¡æ€æ¡†æ ·å¼
â”‚   â”œâ”€â”€ _screens.scss      # å±å¹•æ ·å¼
â”‚   â”œâ”€â”€ _settings.scss     # è®¾ç½®æ ·å¼
â”‚   â”œâ”€â”€ _events.scss       # äº‹ä»¶æ ·å¼
â”‚   â”œâ”€â”€ _toast.scss        # Toast æ ·å¼
â”‚   â””â”€â”€ setup/             # å¼€å±€è®¾ç½®æ ·å¼ï¼ˆä» _setup.scss æ‹†åˆ†ï¼‰
â”‚       â”œâ”€â”€ _index.scss        # å…¥å£æ–‡ä»¶
â”‚       â”œâ”€â”€ _base.scss         # ä¸»å®¹å™¨ã€èƒŒæ™¯å±‚
â”‚       â”œâ”€â”€ _steps-indicator.scss # æ­¥éª¤æŒ‡ç¤ºå™¨
â”‚       â”œâ”€â”€ _forms.scss        # è¡¨å•é€šç”¨æ ·å¼
â”‚       â”œâ”€â”€ _components.scss   # é€šç”¨ç»„ä»¶æ ·å¼
â”‚       â”œâ”€â”€ _step-talent.scss  # å¤©èµ„é€‰æ‹©
â”‚       â”œâ”€â”€ _step-attributes.scss # å±æ€§åˆ†é…
â”‚       â”œâ”€â”€ _step-traits.scss  # å¤©èµ‹é€‰æ‹©
â”‚       â”œâ”€â”€ _step-martial.scss # æ­¦åŠŸé€‰æ‹©
â”‚       â”œâ”€â”€ _step-origin.scss  # å‡ºèº«é€‰æ‹©
â”‚       â”œâ”€â”€ _step-identity.scss # èº«ä»½è®¾ç½®
â”‚       â”œâ”€â”€ _step-confirm.scss # ç¡®è®¤ä¿å­˜
â”‚       â””â”€â”€ _gacha.scss        # æŠ½å¡ç³»ç»Ÿ
â””â”€â”€ utils/               # å·¥å…·å‡½æ•°ç›®å½•
    â”œâ”€â”€ logger.ts              # åˆ†ç±»æ—¥å¿—å·¥å…·ï¼ˆç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨ç¦ç”¨ï¼‰
    â”œâ”€â”€ gameInitializer.ts     # æ¸¸æˆåˆå§‹åŒ–
    â”œâ”€â”€ martialArtsDatabase.ts # åŠŸæ³•æ•°æ®åº“
    â”œâ”€â”€ realmSystem.ts         # å¢ƒç•Œå‡çº§ç³»ç»Ÿ
    â”œâ”€â”€ settingsManager.ts     # æ˜¾ç¤ºè®¾ç½®ç®¡ç†
    â”œâ”€â”€ useFullscreen.ts       # å…¨å±åŠŸèƒ½Hook
    â”œâ”€â”€ variableReader.ts      # é…’é¦†å˜é‡è¯»å–
    â”œâ”€â”€ attributeCalculator.ts # å±æ€§è®¡ç®—
    â””â”€â”€ traitsDatabase.ts      # å¤©èµ‹æ•°æ®åº“
```

---

## 3. æ ¸å¿ƒæ¦‚å¿µä¸å®ç°

### 3.1. é¡µé¢æµç¨‹

```mermaid
graph TD
    Init[App åˆå§‹åŒ–] -- æ£€æŸ¥å­˜æ¡£ --> Check{hasSavedGame?};
    Check -- å·²å¼€å±€ --> D[Game];
    Check -- æœªå¼€å±€ --> A[StartScreen];
    A -- ç‚¹å‡» --> B(SplashScreen);
    B -- æ–°çš„æ•…äº‹ --> C[NewGameSetup 7æ­¥æµç¨‹];
    C -- è¸å…¥æ±Ÿæ¹– --> D[Game];
```

**å¼€å±€æ£€æµ‹é€»è¾‘**: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ assistant æ¶ˆæ¯ + useræ•°æ®ç‰¹å¾å­—æ®µï¼ˆæ€§åˆ«/å¢ƒç•Œ/ç”¨æˆ·åï¼‰

**7æ­¥è§’è‰²åˆ›å»ºæµç¨‹**:

1. å¤©èµ„é€‰æ‹©ï¼ˆå†³å®šæ€»ç‚¹æ•°30/40/55/70ï¼‰
2. ä¸ƒç»´å±æ€§åˆ†é…
3. å¤©èµ‹é€‰æ‹©ï¼ˆå«æŠ½å¡ç³»ç»Ÿï¼‰
4. æ­¦åŠŸé€‰æ‹©ï¼ˆå«æŠ½å¡ç³»ç»Ÿï¼‰
5. å‡ºèº«é€‰æ‹©
6. èº«ä»½è®¾ç½®
7. ç¡®è®¤ä¿å­˜

### 3.2. çŠ¶æ€ç®¡ç†

æ¸¸æˆçŠ¶æ€ä¸é…’é¦†èŠå¤©è®°å½•ç»‘å®šï¼Œå®ç°"å­˜æ¡£äºæ¥¼å±‚"ï¼š

- **æ•°æ®è¯»å–**: ä½¿ç”¨ `getAllVariables()` API è·å–åˆå¹¶åçš„å˜é‡è¡¨
- **é‡è¦**: æ¸¸æˆå˜é‡å­˜å‚¨åœ¨ `stat_data` é”®ä¸‹ï¼Œuseræ•°æ®åœ¨ `stat_data.useræ•°æ®`
- **æ•°æ®ç›‘å¬**: é€šè¿‡ `eventOn` ç›‘å¬ `MESSAGE_RECEIVED` å’Œ `CHAT_CHANGED` äº‹ä»¶
- **è‡ªåŠ¨è¡¥å…¨**: å‰ç«¯åœ¨è¯»å–å˜é‡æ—¶ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è¡¥å…¨ç¼ºå¤±çš„å±æ€§å’ŒåŠŸæ³•ä¿¡æ¯

### 3.2.1. å‰ç«¯å˜é‡è‡ªåŠ¨è¡¥å…¨æœºåˆ¶

å‰ç«¯åœ¨ `readGameData()` è¯»å–å˜é‡æ—¶ï¼Œä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è¡¥å…¨/æ›´æ–°ä»¥ä¸‹æ•°æ®ã€‚

**é‡è¦**: ä¸ºé¿å…æ¯æ¬¡æ¶ˆæ¯éƒ½è§¦å‘ä¸å¿…è¦çš„æ›´æ–°ï¼Œç³»ç»Ÿä½¿ç”¨**ç¼“å­˜æœºåˆ¶**æ¥æ£€æµ‹çŠ¶æ€å˜åŒ–ï¼Œåªæœ‰å½“æ£€æµ‹åˆ°å®é™…å˜åŒ–æ—¶æ‰æ‰§è¡Œæ›´æ–°ã€‚

#### ç¼“å­˜æœºåˆ¶

ç³»ç»Ÿç»´æŠ¤ä¸¤ä¸ªå†…å­˜ç¼“å­˜æ¥è·Ÿè¸ªçŠ¶æ€ï¼š

| ç¼“å­˜                   | é”®æ ¼å¼                        | å­˜å‚¨å†…å®¹             | ç”¨é€”                     |
| ---------------------- | ----------------------------- | -------------------- | ------------------------ |
| `characterStateCache`  | `"ç©å®¶"` æˆ– `"è§’è‰²:{è§’è‰²å}"` | å¢ƒç•Œã€æ˜¯å¦å­˜åœ¨       | æ£€æµ‹æ–°äººç‰©æˆ–å¢ƒç•Œå˜æ›´     |
| `martialArtStateCache` | `"{æ‹¥æœ‰è€…}:{åŠŸæ³•å}"`         | æŒæ¡ç¨‹åº¦ã€æ˜¯å¦å·²è¡¥å…¨ | æ£€æµ‹æ–°åŠŸæ³•æˆ–æŒæ¡ç¨‹åº¦å˜åŠ¨ |

#### è§’è‰²å±æ€§è‡ªåŠ¨è®¡ç®— (`autoUpdateCharacterAttributes`)

**è§¦å‘æ¡ä»¶**ï¼ˆåŸºäºç¼“å­˜æ£€æµ‹ï¼‰ï¼š

1. **æ–°äººç‰©å‡ºç°** - ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥è§’è‰²
2. **å¢ƒç•Œå˜æ›´** - ç¼“å­˜ä¸­çš„å¢ƒç•Œä¸å½“å‰ä¸åŒ

```mermaid
graph LR
    A[è¯»å–å˜é‡] --> B{ç¼“å­˜æ£€æŸ¥}
    B -- æ–°äººç‰© --> C[è®¡ç®—å±æ€§]
    B -- å¢ƒç•Œå˜æ›´ --> C
    B -- æ— å˜åŒ– --> E[è·³è¿‡å¹¶æ›´æ–°ç¼“å­˜]
    C --> D{å†™å…¥æ–¹å¼}
    D -- å±æ€§å­—æ®µä¸å­˜åœ¨ --> F[era:insertByObject]
    D -- å±æ€§å­—æ®µå­˜åœ¨ --> G[era:updateByObject]
    F --> H[æ›´æ–°ç¼“å­˜]
    G --> H
```

**å±æ€§è®¡ç®—å…¬å¼**: æ ¹æ®åˆå§‹å±æ€§ + å¢ƒç•Œ + åŠŸæ³•åŠ æˆï¼Œè®¡ç®—æˆ˜æ–—å±æ€§ï¼ˆè‡‚åŠ›ã€æ ¹éª¨ã€æœºæ•ã€æ´å¯Ÿï¼‰å’Œèµ„æºå±æ€§ï¼ˆæ°”è¡€ã€å†…åŠ›ï¼‰

**æ°”è¡€/å†…åŠ›æ ¼å¼**: `"å½“å‰å€¼/æœ€å¤§å€¼"` å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¦‚ `"800/1000"`ï¼‰

#### åŠŸæ³•è‡ªåŠ¨è¡¥å…¨ (`autoUpdateMartialArts`)

**è§¦å‘æ¡ä»¶**ï¼ˆåŸºäºç¼“å­˜æ£€æµ‹ï¼‰ï¼š

1. **æ–°å¢åŠŸæ³•** - ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥åŠŸæ³•
2. **æŒæ¡ç¨‹åº¦å˜åŠ¨** - ç¼“å­˜ä¸­çš„æŒæ¡ç¨‹åº¦ä¸å½“å‰ä¸åŒï¼ˆéœ€è¦è§£é”æ–°ç‰¹æ€§ï¼‰

AI ç”Ÿæˆçš„åŠŸæ³•æ•°æ®é€šå¸¸åªåŒ…å«åŠŸæ³•åå’ŒæŒæ¡ç¨‹åº¦ï¼Œå‰ç«¯æ ¹æ®åŠŸæ³•æ•°æ®åº“ `data/_åˆå¹¶ååŠŸæ³•.json` è‡ªåŠ¨è¡¥å…¨å®Œæ•´ä¿¡æ¯ï¼š

```mermaid
graph LR
    A[è¯»å–åŠŸæ³•] --> B{ç¼“å­˜æ£€æŸ¥}
    B -- æ–°åŠŸæ³• --> C{æ£€æŸ¥å­—æ®µå®Œæ•´æ€§}
    B -- æŒæ¡ç¨‹åº¦å˜åŠ¨ --> D[æ›´æ–°ç‰¹æ€§: era:updateByObject]
    B -- æ— å˜åŒ– --> E[è·³è¿‡å¹¶æ›´æ–°ç¼“å­˜]
    C -- ç¼ºå°‘åŸºæœ¬å­—æ®µ --> F[è¡¥å…¨: era:insertByObject]
    C -- å­—æ®µå®Œæ•´ --> E
    D --> G[æ›´æ–°ç¼“å­˜]
    F --> G
```

| åœºæ™¯         | è§¦å‘æ¡ä»¶                    | å¤„ç†æ–¹å¼               | ERA API              |
| ------------ | --------------------------- | ---------------------- | -------------------- |
| **è¡¥å…¨**     | æ–°åŠŸæ³• + ç¼ºå°‘ç±»å‹/æè¿°/å“é˜¶ | æ·»åŠ ä¸å­˜åœ¨çš„å­—æ®µ       | `era:insertByObject` |
| **æ›´æ–°ç‰¹æ€§** | æŒæ¡ç¨‹åº¦å˜åŠ¨                | æ ¹æ®æ–°æŒæ¡ç¨‹åº¦è§£é”ç‰¹æ€§ | `era:updateByObject` |
| **è·³è¿‡**     | æ— å˜åŒ–ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰          | ä¸æ‰§è¡Œä»»ä½•å†™å…¥         | -                    |

**è¡¥å…¨åçš„åŠŸæ³•ç»“æ„**:

```yaml
åŠŸæ³•å:
  ç±»å‹: "å†…åŠŸ/å¤–åŠŸ/è½»åŠŸ/å‰‘æ³•ç­‰"
  åŠŸæ³•æè¿°: "åŠŸæ³•çš„è¯¦ç»†æè¿°..."
  åŠŸæ³•å“é˜¶: "ç²—æµ…/ä¼ å®¶/ä¸Šä¹˜/é•‡æ´¾/ç»ä¸–/ä¼ è¯´"
  æŒæ¡ç¨‹åº¦: "åˆçª¥é—¨å¾„"  # ä¿ç•™AIç”Ÿæˆçš„å€¼
  ç‰¹æ€§:
    åˆçª¥é—¨å¾„: "ç‰¹æ€§æè¿°..."  # åªåŒ…å«å·²è§£é”çš„ç‰¹æ€§
```

#### é˜²é‡å¤è°ƒç”¨ä¿æŠ¤

ä¸ºé¿å…å†™å…¥è§¦å‘çš„ `era:writeDone` äº‹ä»¶å¯¼è‡´æ— é™å¾ªç¯ï¼Œè¡¥å…¨å‡½æ•°ä½¿ç”¨åŒé‡ä¿æŠ¤æœºåˆ¶ï¼š

1. **æ ‡è®°ä½é”**:
   - `isUpdatingCharacterAttributes` - è§’è‰²å±æ€§æ›´æ–°é”
   - `isUpdatingMartialArts` - åŠŸæ³•è¡¥å…¨æ›´æ–°é”

2. **ç¼“å­˜æœºåˆ¶**: å³ä½¿é”è¢«é‡Šæ”¾ï¼Œç¼“å­˜æ£€æŸ¥ä¹Ÿä¼šé˜»æ­¢å¯¹æœªå˜åŒ–æ•°æ®çš„é‡å¤æ›´æ–°

### 3.3. æ¶ˆæ¯å‘é€ä¸æ¥æ”¶æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç©å®¶
    participant Frontend as å‰ç«¯
    participant Tavern as é…’é¦† API
    participant LLM as AI æ¨¡å‹

    User->>Frontend: è¾“å…¥æ¶ˆæ¯/ç‚¹å‡»é€‰é¡¹
    Frontend->>Tavern: createChatMessages({role: 'user'}, {refresh: 'none'})
    Frontend->>Tavern: generate({should_stream: true})
    Tavern->>LLM: å‘é€æç¤ºè¯
    LLM-->>Tavern: æµå¼è¿”å›
    Tavern-->>Frontend: AIå®Œæ•´æ–‡æœ¬
    Frontend->>Frontend: æ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼Œè§£æ<option>
    Frontend->>Tavern: createChatMessages({role: 'assistant'}, {refresh: 'none'})
```

### 3.4. å†…å®¹æ˜¾ç¤ºç­–ç•¥

- **ç›´æ¥æ˜¾ç¤ºå®Œæ•´å†…å®¹**: AIå›å¤ç›´æ¥ä½œä¸ºæ­£æ–‡æ˜¾ç¤º
- **åªè§£æé€‰é¡¹**: ä»…è§£æ `<option>` æ ‡ç­¾ç”Ÿæˆå¯ç‚¹å‡»æŒ‰é’®
- **ç”¨æˆ·è‡ªå®šä¹‰è¿‡æ»¤**: é€šè¿‡è®¾ç½®é¢æ¿çš„æ­£åˆ™æ›¿æ¢åŠŸèƒ½è¿‡æ»¤å†…å®¹

### 3.5. æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯                      | æè¿°             |
| ---- | ------------------------- | ---------------- |
| æ¡†æ¶ | React 19 + TypeScript     | æ„å»ºUI           |
| æ„å»º | Webpack                   | å¼€å‘å’Œç”Ÿäº§æ„å»º   |
| åç«¯ | é…’é¦†åŠ©æ‰‹                  | AIäº¤äº’ã€å˜é‡å­˜å‚¨ |
| æ ·å¼ | SCSS (æ¨¡å—åŒ–)             | æ­¦ä¾ é£æ ¼UI       |
| åº“   | `js-yaml`, `lucide-react` | YAMLè§£æã€å›¾æ ‡   |

### 3.6. æ¨¡å—åŒ–æ¶æ„

é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°†å¤§å‹æ–‡ä»¶æ‹†åˆ†ä¸ºèŒè´£å•ä¸€çš„å°æ¨¡å—ï¼š

#### 3.6.1. è‡ªå®šä¹‰ Hooks (`hooks/`)

ä» `App.tsx` æå–çš„çŠ¶æ€ç®¡ç†é€»è¾‘ï¼Œéµå¾ª React Hooks æœ€ä½³å®è·µï¼š

| Hook                | èŒè´£           | ä¸»è¦çŠ¶æ€/åŠŸèƒ½                                       |
| ------------------- | -------------- | --------------------------------------------------- |
| `useDebugLogs`      | è°ƒè¯•æ—¥å¿—ç®¡ç†   | `debugLogs`, `addDebugLog`, `clearDebugLogs`        |
| `useToast`          | Toast æç¤ºç®¡ç† | `toastState`, `showToast`, `hideToast`              |
| `usePageFlow`       | é¡µé¢æµç¨‹çŠ¶æ€   | `currentPage`, `handleStart`, `handleNewGame`       |
| `useGameState`      | æ¸¸æˆçŠ¶æ€ç®¡ç†   | `gameState`, `readGameData`, `DEFAULT_GAME_STATE`   |
| `useEventListeners` | äº‹ä»¶ç›‘å¬é€»è¾‘   | `MESSAGE_RECEIVED`, `CHAT_CHANGED`, `era:writeDone` |
| `useMessageHandler` | æ¶ˆæ¯å‘é€å¤„ç†   | `handleSendMessage`, æ¶ˆæ¯æµæ§åˆ¶                     |

**ä½¿ç”¨ç¤ºä¾‹**:

```typescript
import { useDebugLogs, useGameState, usePageFlow } from './hooks';

function App() {
  const { debugLogs, addDebugLog } = useDebugLogs();
  const { gameState, readGameData } = useGameState();
  const { currentPage, handleStart } = usePageFlow();
  // ...
}
```

#### 3.6.2. é¢æ¿ç»„ä»¶ (`components/panels/`)

ä» `GamePanels.tsx` æ‹†åˆ†çš„ç‹¬ç«‹é¢æ¿ç»„ä»¶ï¼š

| ç»„ä»¶               | è¡Œæ•° | èŒè´£                              |
| ------------------ | ---- | --------------------------------- |
| `EmptyState`       | ~20  | å…±ç”¨ç©ºçŠ¶æ€æç¤º                    |
| `CharacterPanel`   | ~280 | è§’è‰²ä¿¡æ¯ï¼ˆå« StatBarã€Attributeï¼‰ |
| `MartialArtsPanel` | ~230 | åŠŸæ³•åˆ—è¡¨ä¸è¯¦æƒ…                    |
| `InventoryPanel`   | ~125 | èƒŒåŒ…ç‰©å“ç®¡ç†                      |
| `EventsPanel`      | ~80  | äº‹ä»¶åˆ—è¡¨                          |
| `SocialPanel`      | ~145 | ç¤¾äº¤å…³ç³»                          |
| `MapPanel`         | ~10  | åœ°å›¾æ˜¾ç¤º                          |

#### 3.6.3. åˆ†ç±»æ—¥å¿—å·¥å…· (`utils/logger.ts`)

ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨ç¦ç”¨çš„åˆ†ç±»æ—¥å¿—ç³»ç»Ÿï¼š

```typescript
import { initLogger, messageLogger, gameLogger } from './utils/logger';

// ä½¿ç”¨åˆ†ç±»æ—¥å¿—
initLogger.log('ğŸ® åˆå§‹åŒ–å¼€å§‹...');
messageLogger.log('æ”¶åˆ°æ¶ˆæ¯:', message);
gameLogger.error('æ¸¸æˆçŠ¶æ€é”™è¯¯:', error);
```

**æ—¥å¿—ç±»åˆ«**:

| ç±»åˆ«      | å‰ç¼€ | ç”¨é€”          |
| --------- | ---- | ------------- |
| `init`    | ğŸ®    | åˆå§‹åŒ–æµç¨‹    |
| `message` | ğŸ’¬    | æ¶ˆæ¯å¤„ç†      |
| `event`   | ğŸ“¡    | äº‹ä»¶ç›‘å¬      |
| `game`    | ğŸ¯    | æ¸¸æˆçŠ¶æ€      |
| `api`     | ğŸŒ    | API è°ƒç”¨      |
| `ui`      | ğŸ–¼ï¸    | UI ç»„ä»¶       |
| `data`    | ğŸ“Š    | æ•°æ®è¯»å–/è§£æ |

**ç‰¹æ€§**:

- ç”Ÿäº§ç¯å¢ƒ (`NODE_ENV !== 'development'`) è‡ªåŠ¨ç¦ç”¨æ‰€æœ‰æ—¥å¿—
- å¯æŒ‰ç±»åˆ«å•ç‹¬å¼€å…³ï¼ˆä¿®æ”¹ `DEBUG_CATEGORIES`ï¼‰
- æä¾› `logger` å…¨å±€æ—¥å¿—å™¨ç”¨äºä¸éœ€è¦åˆ†ç±»çš„åœºæ™¯

#### 3.6.4. æ ·å¼æ¨¡å— (`styles/setup/`)

ä» `_setup.scss` æ‹†åˆ†çš„å¼€å±€è®¾ç½®æ ·å¼ï¼š

```scss
// styles/setup/_index.scss - å…¥å£æ–‡ä»¶
@import 'base';           // ä¸»å®¹å™¨ã€èƒŒæ™¯å±‚
@import 'steps-indicator'; // æ­¥éª¤æŒ‡ç¤ºå™¨
@import 'forms';          // è¡¨å•é€šç”¨æ ·å¼
@import 'components';     // é€šç”¨ç»„ä»¶
@import 'step-talent';    // å¤©èµ„é€‰æ‹©
@import 'step-attributes'; // å±æ€§åˆ†é…
@import 'step-traits';    // å¤©èµ‹é€‰æ‹©
@import 'step-martial';   // æ­¦åŠŸé€‰æ‹©
@import 'step-origin';    // å‡ºèº«é€‰æ‹©
@import 'step-identity';  // èº«ä»½è®¾ç½®
@import 'step-confirm';   // ç¡®è®¤ä¿å­˜
@import 'gacha';          // æŠ½å¡ç³»ç»Ÿ
```

---

## 4. å˜é‡ç»“æ„

### 4.1. getAllVariables() è¿”å›ç»“æ„

```
getAllVariables() è¿”å›:
â”œâ”€â”€ name, LAST_RECEIVE_TOKENS, ... (ç³»ç»Ÿå˜é‡ï¼Œå¿½ç•¥)
â””â”€â”€ stat_data (æ¸¸æˆå˜é‡)
    â”œâ”€â”€ ä¸–ç•Œä¿¡æ¯
    â”‚   â””â”€â”€ æ—¶é—´ { å¹´, æœˆ, æ—¥, æ—¶ }
    â”œâ”€â”€ useræ•°æ®              â† ç©å®¶ä¿¡æ¯ï¼ˆæ‰å¹³ç»“æ„ï¼‰
    â”‚   â”œâ”€â”€ ç”¨æˆ·å, æ€§åˆ«, å¤–è²Œ, çŠ¶æ€, å¢ƒç•Œ, ä¿®ä¸º
    â”‚   â”œâ”€â”€ æ‰€åœ¨ä½ç½®
    â”‚   â”œâ”€â”€ åŠŸæ³• {}           â† æ³¨æ„æ˜¯"åŠŸæ³•"ä¸æ˜¯"æ­¦åŠŸ"
    â”‚   â”œâ”€â”€ åˆå§‹å±æ€§, å±æ€§
    â”‚   â””â”€â”€ åŒ…è£¹ {}
    â””â”€â”€ è§’è‰²æ•°æ®              â† NPCè§’è‰²
```

### 4.2. ç©å®¶å±æ€§ç»“æ„

- **åˆå§‹å±æ€§** (`InitialAttributes`): å¼€å±€è®¾å®šçš„ä¸ƒç»´å±æ€§ï¼ˆè‡‚åŠ›, æ ¹éª¨, æœºæ•, æ‚Ÿæ€§, æ´å¯Ÿ, é£å§¿, ç¦ç¼˜ï¼‰ï¼Œåç»­åŸºæœ¬å›ºå®šã€‚
- **å½“å‰å±æ€§** (`CurrentAttributes`): æˆ˜æ–—ä¸­å®æ—¶å˜åŒ–çš„äº”ç»´å±æ€§ï¼ˆè‡‚åŠ›, æ ¹éª¨, æœºæ•, æ‚Ÿæ€§, æ´å¯Ÿï¼‰ï¼Œä¸åŒ…å«é£å§¿å’Œç¦ç¼˜ã€‚
- **æˆ˜æ–—/èµ„æºå±æ€§**: æ°”è¡€ã€å†…åŠ›ç­‰ç”±å‰ç«¯æ ¹æ®å½“å‰å±æ€§ã€å¢ƒç•Œã€åŠŸæ³•å®æ—¶è®¡ç®—ã€‚
- **æ³¨æ„**: æ‰€æœ‰å±æ€§çš„é”®åï¼ˆkeyï¼‰å‡ä¸ºä¸­æ–‡ï¼Œä»¥ä¿æŒå˜é‡è¡¨çš„ç»Ÿä¸€æ€§ã€‚

### 4.3. å˜é‡æ˜ å°„è¡¨

| ä¸­æ–‡å˜é‡è·¯å¾„                  | TypeScriptç±»å‹               | æè¿°         |
| ----------------------------- | ---------------------------- | ------------ |
| `stat_data.useræ•°æ®`          | `PlayerData`                 | ç©å®¶å®Œæ•´ä¿¡æ¯ |
| `stat_data.useræ•°æ®.åŠŸæ³•`     | `Record<string, MartialArt>` | å·²å­¦åŠŸæ³•     |
| `stat_data.useræ•°æ®.åˆå§‹å±æ€§` | `InitialAttributes`          | ä¸ƒç»´åˆå§‹å±æ€§ |
| `stat_data.äº‹ä»¶ç³»ç»Ÿ`          | `EventSystem`                | äº‹ä»¶ç³»ç»Ÿ     |

> **æ³¨æ„**: åŠŸæ³•å’ŒåŒ…è£¹ä¸­å¯èƒ½åŒ…å« `$template` æ¨¡æ¿å­—æ®µï¼Œè§£ææ—¶éœ€è¿‡æ»¤

---

## 5. æ•°æ®æµå›¾

```mermaid
graph TD
    subgraph Tavern Helper
        A0[getAllVariables åŸå§‹æ•°æ®]
        A[stat_data - æ¸¸æˆå˜é‡]
        B[Tavern Events]
        ERA[ERA API]
    end

    subgraph React UI
        C(variableReader.ts)
        D{App.tsx}
        E[UI Panels]
        F(NewGameSetup.tsx)
        DB[åŠŸæ³•æ•°æ®åº“ data/_åˆå¹¶ååŠŸæ³•.json]
    end

    subgraph è‡ªåŠ¨è¡¥å…¨
        AC[autoUpdateCharacterAttributes]
        AM[autoUpdateMartialArts]
    end

    A0 -- "rawVariables.stat_data" --> C;
    C -- æ£€æµ‹ç¼ºå¤±å±æ€§ --> AC;
    C -- æ£€æµ‹ç¼ºå¤±åŠŸæ³•ä¿¡æ¯ --> AM;
    DB -- åŠŸæ³•æ•°æ® --> AM;
    AC -- "era:insertByObject/updateByObject" --> ERA;
    AM -- "era:insertByObject/updateByObject" --> ERA;
    ERA -- å†™å…¥å˜é‡ --> A;
    C -- æ˜ å°„ä¸º GameState --> D;
    B -- eventOn --> D;
    D -- props --> E;
    F -- createChatMessages --> A;
```

### 5.1. å˜é‡è¯»å–ä¸è‡ªåŠ¨è¡¥å…¨æµç¨‹

```mermaid
sequenceDiagram
    participant App as App.tsx
    participant VR as variableReader.ts
    participant AC as autoUpdateCharacterAttributes
    participant AM as autoUpdateMartialArts
    participant DB as åŠŸæ³•æ•°æ®åº“
    participant ERA as ERA API

    App->>VR: readGameData()
    VR->>VR: getGameVariables()
    VR->>AC: æ£€æŸ¥è§’è‰²å±æ€§
    AC->>AC: è®¡ç®—æˆ˜æ–—å±æ€§
    AC->>ERA: era:insertByObject æˆ– era:updateByObject
    ERA-->>AC: era:writeDone
    VR->>AM: æ£€æŸ¥åŠŸæ³•æ•°æ®
    AM->>DB: æŸ¥è¯¢åŠŸæ³•ä¿¡æ¯
    DB-->>AM: åŠŸæ³•å®Œæ•´æ•°æ®
    AM->>ERA: era:insertByObject æˆ– era:updateByObject
    ERA-->>AM: era:writeDone
    VR-->>App: GameState
```

---

## 6. ç›¸å…³æ–‡æ¡£

- [`CHANGELOG.md`](./CHANGELOG.md) - å·²çŸ¥é—®é¢˜ä¸ä¿®å¤è®°å½•
- å„æºæ–‡ä»¶çš„ JSDoc æ³¨é‡Š - å‡½æ•°å’Œç±»å‹çš„è¯¦ç»†è¯´æ˜

---

## 7. å…³é”®ç±»å‹é€ŸæŸ¥

```typescript
// åŠŸæ³•ç±»å‹
interface MartialArt {
  type: string;           // å†…åŠŸ/å¤–åŠŸ/è½»åŠŸ/å‰‘æ³•ç­‰
  rank: string;           // ç²—æµ…â†’ä¼ è¯´
  mastery: string;        // åˆçª¥é—¨å¾„â†’å‡ºç¥å…¥åŒ–
  traits: Record<string, string>;
  canUpgrade: boolean;
  upgradeCost: number;
}

// å¼€å±€æµç¨‹æ­¥éª¤
type SetupStep = 'talent' | 'attributes' | 'traits' | 'martial' | 'origin' | 'identity' | 'confirm';

// å¤©èµ„ç­‰çº§
interface TalentTier {
  id: string;          // mortal/talented/genius/legendary
  name: string;        // å‡¡äºº/è‰¯æ‰/å¤©æ‰/ç»ä¸–
  totalPoints: number; // 30/40/55/70
}
```

> è¯¦ç»†ç±»å‹å®šä¹‰è¯·æŸ¥çœ‹ [`types.ts`](./types.ts)
