# 墨剑录 - 已知问题与修复记录

本文档记录项目开发过程中遇到的问题和修复方案，供后续维护参考。

---

## 已修复问题

### 1. 初始化变量后状态未正确读取

**问题描述**：进入聊天界面后，状态中的气血、内力、修为、境界没有正确读取，使用的是默认值。

**根本原因**：在 `App.tsx:handleSetupSubmit()` 中，完成角色创建后直接使用硬编码的默认值设置本地状态，而不是从变量表读取正确值。

**修复方案**：在 `handleSetupSubmit` 完成开局楼层创建后，调用 `readGameData()` 从变量表重新读取游戏状态。

---

### 2. AI 回复后页面只显示开场语

**问题描述**：发出消息，得到 AI 回复后，聊天页面依旧只显示开场语。

**根本原因**：`handleSendMessage` 中的 `generate()` 函数可能返回空值，没有正确处理。

**修复方案**：

1. 在 `generate()` 返回空值时，记录详细的调试日志
2. 在所有错误情况下都记录到调试日志面板

---

### 3. 调试日志为空

**问题描述**：设置里的消息调试日志为空，没有正确记录消息。

**根本原因**：`addDebugLog` 只在成功情况下被调用。

**修复方案**：

1. AI 回复为空时，记录空回复信息到调试日志
2. 发生异常时，记录错误信息和堆栈到调试日志
3. 确保所有用户发送的消息都被记录

**调试日志记录点**：

| 位置                           | 类型        | 内容           |
| ------------------------------ | ----------- | -------------- |
| `handleSetupSubmit`            | `prompt`    | 开局设置摘要   |
| `handleSetupSubmit`            | `assistant` | 预设开场白     |
| `handleSendMessage` 步骤1.5    | `prompt`    | 用户发送的消息 |
| `handleSendMessage` 步骤5      | `assistant` | AI 完整回复    |
| `handleSendMessage` 空回复处理 | `assistant` | 空回复信息     |
| `handleSendMessage` catch块    | `assistant` | 异常信息       |

---

### 4. 移动端侧边栏优化

**变更描述**：将移动端的底部导航栏改为左侧抽屉式侧边栏。

**变更原因**：底部导航栏在移动端占用过多屏幕空间。

**实现方案**：

1. **样式修改** (`_navigation.scss`)：
   - 新增 `.nav-menu-toggle` 菜单按钮样式
   - 新增 `.nav-sidebar-overlay` 遮罩层样式
   - 修改 `.nav-sidebar` 移动端样式：`position: fixed`，滑动动画

2. **逻辑修改** (`App.tsx`)：
   - 新增 `isSidebarOpen` 状态
   - 新增 `toggleSidebar()` / `closeSidebar()` / `handleNavClick()` 方法

**响应式设计**：

- 移动端 (< 768px)：侧边栏默认隐藏，显示左上角菜单按钮
- 桌面端 (≥ 768px)：侧边栏固定显示

---

### 5. 天赋/武功抽卡后点数双重扣费

**问题描述**：角色创建页面抽取天赋后，点数异常变成负数。

**根本原因**：抽卡时存在双重扣费：

1. 抽卡费用没有被单独记录
2. 抽到的天赋被加入后，天赋本身的 `cost` 也会被计算
3. 武功抽卡存在同样的问题

**修复方案**：

1. 新增状态变量跟踪抽卡消耗：
   - `traitDrawCostUsed`：天赋抽卡消耗
   - `martialArtsDrawCostUsed`：武功抽卡消耗

2. 修改点数计算：跳过抽卡获得的天赋/武功

3. 修改 `remainingPoints` 计算公式：

   ```typescript
   remainingPoints = totalPoints
     - attributePointsUsed
     - traitPointsUsed
     - martialArtsPointsUsed
     - traitDrawCostUsed
     - martialArtsDrawCostUsed
   ```

**点数计算逻辑**：

- 直接选择天赋：消耗天赋本身的 cost
- 抽卡获得天赋：只消耗抽卡费用（正面5点/负面0点/混合3点）
- 直接选择武功：消耗品阶对应点数（粗浅2点→传说30点）
- 抽卡获得武功：只消耗抽卡费用（5点）

---

## 角色存档系统

### 存档功能概述

角色创建流程支持保存配置到本地，以便后续快速加载。

### 存档数据结构

```typescript
interface CharacterBuild {
  id: string;           // 唯一ID: build_时间戳_随机串
  name: string;         // 存档名称
  createdAt: number;    // 创建时间戳
  talentTier: string;   // 天资ID
  attributes: InitialAttributes;
  traits: string[];
  martialArts: string[];
  origin: string;
  locationInfo: { year, month, day, location, eventName? };
  characterInfo: { name, gender, appearance, age };
}
```

### localStorage 存储键

| 键名                     | 类型               | 描述           |
| ------------------------ | ------------------ | -------------- |
| `wuxia_character_builds` | `CharacterBuild[]` | 角色存档列表   |
| `wuxia_custom_traits`    | 自定义天赋数组     | 用户自定义天赋 |
| `wuxia_display_settings` | `DisplaySettings`  | 显示设置       |

### 存档验证

加载存档时进行验证：

1. 必需字段检查：`id`、`name`、`createdAt`、`talentTier`、`attributes`、`traits`、`martialArts`
2. 类型检查：确保数组和对象类型正确
3. 兼容性处理：对缺失的可选字段补全默认值

---

## 游戏系统参考

### 境界升级消耗表

| 大境界   | 初期   | 中期   | 后期   | 圆满   |
| -------- | ------ | ------ | ------ | ------ |
| 不入流   | 0      | 10     | 20     | 30     |
| 三流     | 50     | 80     | 120    | 160    |
| 二流     | 250    | 350    | 500    | 700    |
| 一流     | 1000   | 1500   | 2200   | 3000   |
| 宗师     | 5000   | 8000   | 12000  | 18000  |
| 绝顶     | 30000  | 50000  | 80000  | 120000 |
| 陆地神仙 | 200000 | 350000 | 550000 | 999999 |

### 功法升级消耗表

| 品阶 | 基础消耗 | 初窥→略有 | 略有→融会 | 融会→炉火 | 炉火→出神 |
| ---- | -------- | --------- | --------- | --------- | --------- |
| 粗浅 | 100      | 100       | 200       | 400       | 800       |
| 传家 | 300      | 300       | 600       | 1200      | 2400      |
| 上乘 | 800      | 800       | 1600      | 3200      | 6400      |
| 镇派 | 1500     | 1500      | 3000      | 6000      | 12000     |
| 绝世 | 4000     | 4000      | 8000      | 16000     | 32000     |
| 传说 | 10000    | 10000     | 20000     | 40000     | 80000     |

**悟性折扣公式**：

```
偏离值 = 悟性 - 基准悟性
折扣率 = clamp(偏离值 × 5%, -60%, +60%)
实际消耗 = 基础消耗 × (1 - 折扣率)
```

### 属性点数消耗表

| 属性值范围 | 点数效果  | 每点消耗 | 触发天赋类型 |
| ---------- | --------- | -------- | ------------ |
| 0-1        | 获得5点   | 5        | 严重负面     |
| 2-5        | 获得1~2点 | 1~2      | 中等负面     |
| 6-8        | 消耗1点   | 1        | 无           |
| 9-12       | 消耗1点   | 1        | 无           |
| 13-16      | 消耗2点   | 2        | 中等正面     |
| 17-20      | 消耗3点   | 3        | 强力正面     |

### 福缘点数消耗表（独立系统）

| 福缘值范围 | 点数效果 | 触发天赋类型 |
| ---------- | -------- | ------------ |
| -6 ~ -5    | 获得5点  | 严重负面     |
| -4 ~ -3    | 获得2点  | 中等负面     |
| -2 ~ -1    | 获得1点  | 中等负面     |
| 0 ~ 2      | 消耗1点  | 无           |
| 3 ~ 6      | 消耗1点  | 无           |
| 7 ~ 10     | 消耗2点  | 中等正面     |
| 11 ~ 14    | 消耗3点  | 强力正面     |

### 预设开场白列表

```
"剑指苍穹，且试天下。"
"大好河山，请君入局。"
"此去经年，且让这江湖，听听你的名字。"
"少年纵马，且看这一遭，谁主沉浮。"
"风起青萍，乾坤未定，请入红尘一炼。"
"半柄残剑，一壶浊酒，阁下的路，由此开始了。"
"宿命已启，落子无悔。"
"江湖未远，请君执剑，共赴生死之约。"
"风雪归人，请踏这一径江湖路。"
"看尽人间花开落，此间江湖，等君久矣。"
"一马一剑一蓑衣，万水千山总是情。请启程。"
```
